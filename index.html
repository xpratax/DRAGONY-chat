<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H$KASS</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<h1>H$KASS</h1>
<img class="logo" src="public/logo.png" alt="Logo H$KASS"/>

<!-- Login simples -->
<div id="loginDiv">
    <input type="text" id="username" placeholder="Nome de usuário">
    <input type="password" id="password" placeholder="Senha (opcional)">
    <button onclick="login()">Entrar</button>
</div>

<!-- Chat -->
<div id="chatDiv" style="display:none;">
    <div id="chat-container"></div>
    <input type="text" id="msgInput" placeholder="Digite sua mensagem" onkeydown="if(event.key==='Enter'){sendMessage();}">
    <button onclick="sendMessage()">Enviar</button>
</div>

<script>
let currentUser = null;
const chatContainer = document.getElementById('chat-container');

async function login(){
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!username){ alert("Digite um nome de usuário"); return; }

    try{
        const res = await fetch('/api/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        currentUser = data;
        alert(`Logado como ${data.username} ${data.isMod ? '(Moderador)' : ''}`);

        // esconde login, mostra chat
        document.getElementById('loginDiv').style.display='none';
        document.getElementById('chatDiv').style.display='block';
    } catch(err){ console.error(err); }
}

async function sendMessage(){
    if(!currentUser){ alert("Faça login primeiro"); return; }

    const input = document.getElementById('msgInput');
    if(input.value.trim()==='') return;

    try{
        const res = await fetch('/api/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ username: currentUser.username, message: input.value })
        });
        const data = await res.json();
        displayMessages(data.messages);
    } catch(err){ console.error(err); }

    input.value='';
}

function displayMessages(msgs){
    chatContainer.innerHTML = '';
    msgs.forEach(m=>{
        const div = document.createElement('div');
        div.innerHTML = `<strong>${m.username}:</strong> ${m.message}`;
        chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Atualiza mensagens a cada 2s
setInterval(async ()=>{
    try{
        const res = await fetch('/api/chat');
        const data = await res.json();
        displayMessages(data.messages);
    } catch(err){ console.error(err); }
},2000);
</script>
</body>
</html>
